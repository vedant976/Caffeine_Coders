<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelPay</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.05)",
                        glassBorder: "rgba(255, 255, 255, 0.1)",
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: radial-gradient(circle at top left, #4c0519, #020617, #1e1b4b);
            /* Deep pink/slate/indigo base */
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(232, 121, 249, 0.5);
            /* Pink Glow */
            box-shadow: 0 10px 20px -3px rgba(168, 85, 247, 0.2);
        }

        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:active {
            transform: scale(0.96);
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d946ef;
            /* Fuchsia */
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header class="flex justify-between items-end pb-6 border-b border-fuchsia-500/20">
            <div>
                <h1
                    class="text-6xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-lime-400 via-yellow-400 to-pink-500 tracking-tight mb-2">
                    SentinelPay
                </h1>
                <p class="text-pink-200/60 text-lg font-light tracking-wide">The AI sentinel guarding payment
                    reliability</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="px-4 py-1.5 rounded-full text-xs font-bold tracking-wider uppercase border"
                    :class="connectionStatus ? 'bg-lime-500/10 text-lime-400 border-lime-500/30' : 'bg-red-500/10 text-red-400 border-red-500/30'">
                    <span class="inline-block w-2 h-2 rounded-full mr-2"
                        :class="connectionStatus ? 'bg-lime-400 animate-pulse' : 'bg-red-400'"></span>
                    {{ connectionStatus ? 'System Online' : 'Offline' }}
                </div>
            </div>
        </header>

        <!-- Top Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="card p-6 relative overflow-hidden group">
                <div
                    class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-500/30 transition-all">
                </div>

                <div class="text-slate-400 text-sm font-medium uppercase tracking-widest mb-2">Success Rate</div>
                <div class="flex items-baseline gap-2">
                    <div class="text-5xl font-bold tracking-tighter" :class="getSrColor(metrics.success_rate)">
                        {{ (metrics.success_rate * 100).toFixed(1) }}%
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="w-full bg-slate-700/50 h-1.5 rounded-full mt-4 overflow-hidden">
                    <div class="h-full transition-all duration-500 ease-out"
                        :class="metrics.success_rate >= 0.95 ? 'bg-gradient-to-r from-emerald-400 to-emerald-600' : 'bg-gradient-to-r from-red-400 to-red-600'"
                        :style="{ width: (metrics.success_rate * 100) + '%' }"></div>
                </div>
                <div class="text-xs text-slate-500 mt-2 font-mono">Target: > 95.0%</div>
            </div>

            <div class="card p-6 relative overflow-hidden group">
                <div
                    class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/20 rounded-full blur-2xl group-hover:bg-yellow-500/30 transition-all">
                </div>

                <div class="text-slate-400 text-sm font-medium uppercase tracking-widest mb-2">Avg Latency</div>
                <div class="text-5xl font-bold text-white tracking-tighter">
                    {{ metrics.avg_latency.toFixed(0) }}<span class="text-2xl text-slate-500 font-normal ml-1">ms</span>
                </div>
                <div class="w-full bg-slate-700/50 h-1.5 rounded-full mt-4 overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 transition-all duration-500"
                        :style="{ width: Math.min((metrics.avg_latency / 1000) * 100, 100) + '%' }"></div>
                </div>
                <div class="text-xs text-slate-500 mt-2 font-mono">Target: < 400ms</div>
                </div>

                <div class="card p-6 relative overflow-hidden group">
                    <div
                        class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/20 rounded-full blur-2xl group-hover:bg-purple-500/30 transition-all">
                    </div>

                    <div class="text-slate-400 text-sm font-medium uppercase tracking-widest mb-2">Throughput</div>
                    <div class="text-5xl font-bold text-purple-400 tracking-tighter">{{ metrics.total }}</div>
                    <div class="text-sm text-purple-400/60 font-medium mt-1">transactions / min</div>
                    <div class="flex gap-1 mt-4">
                        <div v-for="i in 10" :key="i" class="h-1.5 flex-1 rounded-full"
                            :class="i < (metrics.total % 10) + 1 ? 'bg-purple-500/50' : 'bg-slate-700/50'"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Issuer Status -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>
                                Issuer Performance
                            </h2>
                            <div class="text-xs text-slate-400 font-mono bg-slate-800/50 px-2 py-1 rounded">Live
                                Data
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm border-separate border-spacing-y-2">
                                <thead>
                                    <tr class="text-slate-400 text-xs uppercase tracking-wider">
                                        <th class="pb-2 pl-2">Issuer</th>
                                        <th class="pb-2 text-right">Vol</th>
                                        <th class="pb-2 text-right">Success Rate</th>
                                        <th class="pb-2 text-right">Latency</th>
                                        <th class="pb-2 text-center">Status</th>
                                        <th class="pb-2 text-center">Simulate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(data, issuer) in metrics.by_issuer" :key="issuer"
                                        class="group transition-colors rounded-lg bg-slate-800/30 hover:bg-slate-800/60">
                                        <td
                                            class="py-3 pl-3 rounded-l-lg font-medium text-white capitalize flex items-center gap-2">
                                            <div
                                                class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center text-xs font-bold text-gray-400 border border-gray-600">
                                                {{ issuer.substring(0,1).toUpperCase() }}
                                            </div>
                                            {{ issuer.replace(/_/g, ' ') }}
                                        </td>
                                        <td class="py-3 text-right text-slate-400 font-mono">{{ data.volume }}</td>
                                        <td class="py-3 text-right font-bold font-mono"
                                            :class="getSrColor(data.success_rate)">
                                            {{ (data.success_rate * 100).toFixed(1) }}%
                                        </td>
                                        <td class="py-3 text-right text-slate-400 font-mono">{{
                                            data.avg_latency.toFixed(0) }}ms</td>
                                        <td class="py-3 text-center">
                                            <span
                                                class="px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wide border"
                                                :class="routes[issuer] !== false ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'">
                                                {{ routes[issuer] !== false ? 'Active' : 'Rerouted' }}
                                            </span>
                                        </td>
                                        <td class="py-3 pr-3 text-center rounded-r-lg">
                                            <div
                                                class="flex justify-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                                <!-- Fault Button -->
                                                <button @click="injectFault(issuer, 0.5)"
                                                    title="Inject Failure (50% Drop)"
                                                    class="w-8 h-8 flex items-center justify-center rounded bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white transition-all border border-red-500/30">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                                                        <line x1="12" y1="2" x2="12" y2="12"></line>
                                                    </svg>
                                                </button>
                                                <!-- Reset Button -->
                                                <button @click="injectFault(issuer, 1.0)" title="Reset Health"
                                                    class="w-8 h-8 flex items-center justify-center rounded bg-emerald-500/20 hover:bg-emerald-500 text-emerald-500 hover:text-white transition-all border border-emerald-500/30">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="23 4 1 4 4 10 23 4"></polyline>
                                                        <line x1="12" y1="12" x2="12" y2="20"></line>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Agent Logs -->
                    <div class="card p-0 h-[30rem] flex flex-col overflow-hidden border-purple-500/30">
                        <div class="p-6 border-b border-white/5 bg-white/5 flex justify-between items-center">
                            <h2 class="text-xl font-bold flex items-center gap-3">
                                <span class="relative flex h-3 w-3">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-pink-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-pink-500"></span>
                                </span>
                                Agent Reasoning Engine
                            </h2>
                            <span class="text-xs uppercase tracking-widest text-pink-300/50 font-bold">Live
                                Stream</span>
                        </div>

                        <div class="flex-1 overflow-y-auto font-mono text-sm p-6 space-y-4 bg-black/20">
                            <div v-for="(log, idx) in logs" :key="idx" class="flex gap-4 animate-fade-in">
                                <div class="text-xs text-slate-500 whitespace-nowrap pt-1">
                                    {{ log.timestamp.split('T')[1].split('.')[0] }}
                                </div>
                                <div class="flex-1 space-y-1">
                                    <div class="text-xs font-bold uppercase tracking-wider" :class="{
                                         'text-pink-400': log.stage === 'Reason',
                                         'text-blue-400': log.stage === 'Observe',
                                         'text-orange-400': log.stage === 'Decide',
                                         'text-emerald-400': log.stage === 'Act'
                                     }">
                                        {{ log.stage }}
                                    </div>
                                    <div class="text-slate-300 leading-relaxed">{{ log.message }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="space-y-6">
                    <!-- Manual Override -->
                    <div class="card p-6">
                        <div class="flex items-center gap-2 mb-6">
                            <h2 class="text-lg font-bold">Manual Routing</h2>
                            <div class="h-px bg-white/10 flex-1"></div>
                        </div>

                        <div class="space-y-3">
                            <div v-for="(enabled, issuer) in routes" :key="issuer"
                                class="flex justify-between items-center p-3 rounded-lg border transition-all"
                                :class="enabled ? 'bg-slate-800/50 border-white/5' : 'bg-red-900/10 border-red-500/20'">
                                <div class="flex flex-col">
                                    <span class="capitalize font-medium text-sm">{{ issuer.replace(/_/g, ' ')
                                        }}</span>
                                    <span class="text-[10px] uppercase font-bold tracking-wider"
                                        :class="enabled ? 'text-emerald-500' : 'text-red-500'">
                                        {{ enabled ? '• Active' : '• Disabled' }}
                                    </span>
                                </div>

                                <button @click="toggleRoute(issuer, !enabled)"
                                    class="w-12 h-6 rounded-full transition-all duration-300 relative shadow-inner"
                                    :class="enabled ? 'bg-gradient-to-r from-emerald-500 to-teal-600' : 'bg-slate-700'">
                                    <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-all duration-300 shadow-sm"
                                        :class="enabled ? 'translate-x-6' : 'translate-x-0'"></div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Info Card -->
                    <!-- Static Chat Card -->
                    <div class="card p-0 flex flex-col h-[600px] relative overflow-hidden border-pink-500/30">
                        <!-- Chat Header -->
                        <div
                            class="p-4 border-b border-white/10 bg-gradient-to-r from-pink-900/20 to-purple-900/20 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <span
                                        class="absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 animate-ping"></span>
                                    <div class="w-2.5 h-2.5 bg-emerald-500 rounded-full relative"></div>
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-sm">Payment Ops Agent</h3>
                                    <p class="text-[10px] text-pink-200/60 uppercase tracking-wider font-bold">Sentinel
                                        AI</p>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Area -->
                        <div class="flex-1 overflow-y-auto p-4 space-y-4 font-mono text-sm bg-black/20"
                            ref="chatContainer">
                            <div v-for="(msg, i) in chatMessages" :key="i" class="flex gap-3"
                                :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                                <div class="max-w-[85%] p-3 rounded-lg text-xs leading-relaxed transition-all duration-300"
                                    :class="msg.role === 'user' ? 'bg-pink-600 text-white rounded-tr-none shadow-lg shadow-pink-900/20' : 'bg-slate-800 text-slate-200 border border-white/5 rounded-tl-none'">
                                    <span v-if="msg.role === 'agent'"
                                        class="block text-[9px] text-pink-400 font-bold mb-1 uppercase tracking-wider">Sentinel</span>
                                    <span>{{ msg.text }}</span>
                                </div>
                            </div>
                            <div v-if="isTyping" class="flex gap-2">
                                <div class="bg-slate-800 p-3 rounded-lg rounded-tl-none border border-white/5">
                                    <div class="flex gap-1">
                                        <span class="w-1.5 h-1.5 bg-pink-400 rounded-full animate-bounce"></span>
                                        <span
                                            class="w-1.5 h-1.5 bg-pink-400 rounded-full animate-bounce delay-100"></span>
                                        <span
                                            class="w-1.5 h-1.5 bg-pink-400 rounded-full animate-bounce delay-200"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="p-3 border-t border-white/10 bg-white/5">
                            <form @submit.prevent="sendMessage" class="flex gap-2">
                                <input v-model="chatInput" type="text"
                                    placeholder="Type 'scale sbi' to boost performance..."
                                    class="flex-1 bg-slate-800/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-pink-500/50 placeholder-slate-500 font-mono transition-all">
                                <button type="submit" :disabled="!chatInput || isTyping"
                                    class="bg-pink-600 hover:bg-pink-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-3 py-2 rounded-lg transition-all shadow-lg shadow-pink-600/20">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chatbot FAB & Window -->


        <script>
            const { createApp, ref, onMounted, nextTick } = Vue;

            createApp({
                setup() {
                    const metrics = ref({ total: 0, success_rate: 1.0, avg_latency: 0, by_issuer: {} });
                    const logs = ref([]);
                    const routes = ref({});
                    const connectionStatus = ref(false);

                    // Chat State
                    // Chat State (Static)
                    const chatInput = ref("");
                    const chatMessages = ref([
                        { role: 'agent', text: "Hello. I am SentinelPay. I'm monitoring transaction reliability. How can I assist?" }
                    ]);
                    const isTyping = ref(false);
                    const chatContainer = ref(null);

                    const API_URL = "http://localhost:8000/api";

                    const fetchData = async () => {
                        try {
                            const [mRes, lRes, rRes] = await Promise.all([
                                fetch(`${API_URL}/metrics`),
                                fetch(`${API_URL}/agent/logs`),
                                fetch(`${API_URL}/config/routes`)
                            ]);

                            if (mRes.ok) metrics.value = await mRes.json();
                            if (lRes.ok) logs.value = await lRes.json();
                            if (rRes.ok) routes.value = await rRes.json();
                            connectionStatus.value = true;
                        } catch (e) {
                            connectionStatus.value = false;
                            console.error(e);
                        }
                    };

                    const injectFault = async (issuer, health) => {
                        await fetch(`${API_URL}/simulation/fault?issuer_id=${issuer}&health=${health}`, { method: 'POST' });
                    };

                    const toggleRoute = async (issuer, enabled) => {
                        await fetch(`${API_URL}/config/routes?issuer_id=${issuer}&enabled=${enabled}`, { method: 'POST' });
                        fetchData();
                    };

                    const getSrColor = (sr) => {
                        if (sr >= 0.95) return 'text-emerald-400';
                        if (sr >= 0.8) return 'text-yellow-400';
                        return 'text-red-500';
                    };

                    const sendMessage = async () => {
                        if (!chatInput.value.trim()) return;

                        const text = chatInput.value;
                        chatMessages.value.push({ role: 'user', text });
                        chatInput.value = "";
                        isTyping.value = true;

                        // Scroll to bottom
                        nextTick(() => {
                            if (chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight
                        });

                        try {
                            const res = await fetch(`${API_URL}/agent/chat`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ message: text })
                            });

                            if (res.ok) {
                                const data = await res.json();
                                chatMessages.value.push({ role: 'agent', text: data.response });
                            } else {
                                chatMessages.value.push({ role: 'agent', text: "Error: Could not reach agent core." });
                            }
                        } catch (e) {
                            chatMessages.value.push({ role: 'agent', text: "Connection Error." });
                        } finally {
                            isTyping.value = false;
                            nextTick(() => {
                                if (chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight
                            });
                        }
                    };

                    onMounted(() => {
                        fetchData();
                        setInterval(fetchData, 1000); // 1s polling
                    });

                    return {
                        metrics, logs, routes, connectionStatus,
                        injectFault, toggleRoute, getSrColor,
                        injectFault, toggleRoute, getSrColor,
                        chatInput, chatMessages, isTyping, chatContainer, sendMessage
                    };
                }
            }).mount('#app');
        </script>
</body>

</html>